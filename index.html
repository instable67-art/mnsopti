<script>
  const API_URL = "https://mnsopti-bot.onrender.com";

  function openDiscord(){
    window.open("https://discord.gg/mnsopti","_blank");
  }
  function scrollToTickets(){
    document.getElementById("ticketsSection").scrollIntoView({behavior:"smooth"});
  }

  // UI status
  async function checkApiOnline(){
    const el = document.getElementById("apiState");
    if(!el) return;

    try{
      const r = await fetch(API_URL + "/status", { cache:"no-store" });
      const j = await r.json();
      if(j.online && j.botReady){
        el.textContent = "✅ API + Bot en ligne";
      }else if(j.online){
        el.textContent = "⚠️ API en ligne, bot pas prêt";
      }else{
        el.textContent = "❌ API offline";
      }
    }catch{
      el.textContent = "❌ API inaccessible";
    }
  }
  checkApiOnline();
  setInterval(checkApiOnline, 30000);

  // Tickets local storage
  const STORAGE_KEY = "mnsopti_tickets_v1";
  function loadTickets(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]")}catch{return []} }
  function saveTickets(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); renderTickets(); }
  function clearTickets(){ localStorage.removeItem(STORAGE_KEY); renderTickets(); }
  function removeTicket(id){ saveTickets(loadTickets().filter(t=>t.id!==id)); }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function renderTickets(){
    const list = loadTickets();
    const root = document.getElementById("ticketsList");
    if(!list.length){
      root.innerHTML = '<div class="muted">Aucun ticket enregistré.</div>';
      return;
    }
    root.innerHTML = list.map(t => `
      <div class="ticketBox">
        <div class="ticketTop">
          <div><b>${escapeHtml(t.subject || "Ticket")}</b></div>
          <div class="ticketId">ID: <b>${escapeHtml(t.id)}</b> • ${new Date(t.createdAt).toLocaleString()}</div>
        </div>
        <div class="ticketMsg">${escapeHtml(t.details || "")}</div>
        <div class="ticketMsg" style="color:#b9b9b9;margin-top:8px;">Contact: ${escapeHtml(t.contact || "—")}</div>
        <div class="btnRow" style="margin-top:10px;">
          <button type="button" class="btnGhost" onclick="openDiscord()">Aller sur Discord</button>
          <button type="button" class="btnGhost" onclick="removeTicket('${t.id}')">Supprimer</button>
        </div>
      </div>
    `).join("");
  }
  renderTickets();

  // Form submit
  const ticketForm = document.getElementById("ticketForm");
  ticketForm.addEventListener("submit", async (e)=>{
    e.preventDefault();

    const data = {
      pseudo: document.getElementById("pseudo").value.trim(),
      contact: document.getElementById("contact").value.trim(),
      subject: document.getElementById("subject").value.trim(),
      details: document.getElementById("details").value.trim()
    };

    try{
      const res = await fetch(API_URL + "/api/ticket",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(data)
      });

      const json = await res.json().catch(()=> ({}));

      if(res.ok && json.ok){
        const id = json.id || ("MNS-" + Math.random().toString(36).slice(2,10).toUpperCase());
        const list = loadTickets();
        list.unshift({
          id,
          subject: data.subject,
          details: data.details,
          contact: data.contact,
          createdAt: Date.now()
        });
        saveTickets(list);

        alert("✅ Ticket créé ! ID: " + id);
        if(json.channelUrl) window.open(json.channelUrl, "_blank");

        ticketForm.reset();
        scrollToTickets();
        return;
      }

      // ✅ Erreur claire venant du serveur (plus de message mensonger)
      alert("❌ Erreur ticket: " + (json.error || "Erreur inconnue") + (json.code ? "\nCode: " + json.code : ""));

    }catch(err){
      alert("❌ Erreur réseau / CORS. Vérifie que l’API est en ligne et que CORS est OK.");
    }
  });
</script>
